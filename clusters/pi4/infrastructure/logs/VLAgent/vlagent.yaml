apiVersion: operator.victoriametrics.com/v1
kind: VLAgent
metadata:
  name: vlagent
  namespace: vm
spec:
  # Конфігурація спеціально для K3s
  # K3s має інші шляхи логів та особливості архітектури

  # Віддалений запис до VictoriaLogs
  remoteWrite:
    - url: "http://vlinsert-dev-logs.vm.svc.cluster.local:9481/internal/insert"
        
  # Локальне сховище з урахуванням специфіки K3s
  storage:
    volumeClaimTemplate:
      spec:
        # K3s часто використовує local-path provisioner
        storageClassName: "local-path"  
        resources:
          requests:
            storage: 5Gi
        # Режим доступу для K3s
        accessModes:
          - ReadWriteOnce
          
  # Додаткові аргументи оптимізовані для K3s
  extraArgs:
    # Збільшуємо розмір буфера для K3s (може генерувати великі логи)
    insert.maxLineSizeBytes: "2MiB"
    # Детальне логування для діагностики K3s проблем
    loggerLevel: "INFO"
    # Таймаути адаптовані для K3s
    http.timeout: "45s"
    # Оптимізація для менших ресурсів K3s
    workers: "1"
    # Memory limit для K3s
    memory.allowedPercent: "80"
    
  # Ресурси адаптовані для K3s (зазвичай менші вузли)
  resources:
    requests:
      cpu: "50m"      # Менше CPU для K3s
      memory: "64Mi"  # Менше пам'яті для K3s
    limits:
      cpu: "200m"
      memory: "256Mi"
      
  # DaemonSet конфігурація для K3s
  # Запускаємо на всіх вузлах K3s
  nodeSelector: {}  # Прибираємо обмеження на конкретний hostname
  
  # Толеранси для роботи з K3s master/worker вузлами
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/control-plane"  
      operator: "Exists"
      effect: "NoSchedule"
    # K3s специфічні taints
    - key: "k3s.io/hostname"
      operator: "Exists"
      
  # Volume mounts специфічні для K3s
  volumeMounts:
    - name: k3s-logs
      mountPath: /var/lib/rancher/k3s/server/logs
      readOnly: true
    - name: k3s-agent-logs  
      mountPath: /var/lib/rancher/k3s/agent/logs
      readOnly: true
    - name: system-journal
      mountPath: /var/log/journal
      readOnly: true
      
  volumes:
    - name: k3s-logs
      hostPath:
        path: /var/lib/rancher/k3s/server/logs
        type: DirectoryOrCreate
    - name: k3s-agent-logs
      hostPath:
        path: /var/lib/rancher/k3s/agent/logs  
        type: DirectoryOrCreate
    - name: system-journal
      hostPath:
        path: /var/log/journal
        type: DirectoryOrCreate
        