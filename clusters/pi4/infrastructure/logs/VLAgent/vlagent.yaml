apiVersion: operator.victoriametrics.com/v1
kind: VLAgent
metadata:
  name: vlagent
  namespace: vm
spec:
  # Конфігурація спеціально для K3s
  # K3s має інші шляхи логів та особливості архітектури

  # Віддалений запис до VictoriaLogs
  remoteWrite:
    - url: "http://vlinsert-dev-logs.vm.svc.cluster.local:9481"
        
  # Локальне сховище з урахуванням специфіки K3s
  storage:
    volumeClaimTemplate:
      spec:  
        resources:
          requests:
            storage: 5Gi
        # Режим доступу для K3s
        accessModes:
          - ReadWriteOnce
          
  # Додаткові аргументи оптимізовані для K3s
  extraArgs:
    # Збільшуємо розмір буфера для K3s (може генерувати великі логи)
    insert.maxLineSizeBytes: "2MiB"
    # Детальне логування для діагностики K3s проблем
    loggerLevel: "INFO"
    # Memory limit для K3s
    memory.allowedPercent: "80"
    
  # Ресурси адаптовані для K3s (зазвичай менші вузли)
  resources:
    requests:
      cpu: "50m"      # Менше CPU для K3s
      memory: "64Mi"  # Менше пам'яті для K3s
    limits:
      cpu: "200m"
      memory: "256Mi"
      
  # DaemonSet конфігурація для K3s
  # Запускаємо на всіх вузлах K3s
  nodeSelector: {}  # Прибираємо обмеження на конкретний hostname
  
  # Толеранси для роботи з K3s master/worker вузлами
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/control-plane"  
      operator: "Exists"
      effect: "NoSchedule"
    # K3s специфічні taints
    - key: "k3s.io/hostname"
      operator: "Exists"
      
